name: Generate PDF

on:
  workflow_dispatch:
    inputs:
      wp_post_ids:
        description: 'WordPressÊäïÁ®øIDÔºàË§áÊï∞„ÅÆÂ†¥Âêà„ÅØ„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ'
        required: true
        default: ''
      target_slug:
        description: '„Éì„É´„ÉâÂØæË±°„ÅÆ„Çπ„É©„ÉÉ„Ç∞ÔºàÊåáÂÆö„Åå„Å™„Åë„Çå„Å∞ÊúÄÂàù„ÅÆID„Çí‰ΩøÁî®Ôºâ'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'          

      - name: Install dependencies
        run: npm ci

      - name: Set build slug
        id: set-slug
        run: |
          TARGET_SLUG="${{ github.event.inputs.target_slug }}"
          if [ -z "$TARGET_SLUG" ]; then
            # „Çø„Éº„Ç≤„ÉÉ„Éà„Çπ„É©„ÉÉ„Ç∞„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÊúÄÂàù„ÅÆID„Çí‰ΩøÁî®
            IDS="${{ github.event.inputs.wp_post_ids }}"
            FIRST_ID=$(echo $IDS | cut -d ',' -f1)
            TARGET_SLUG=$FIRST_ID
          fi
          echo "‰ΩøÁî®„Åô„Çã„Çπ„É©„ÉÉ„Ç∞: $TARGET_SLUG"
          echo "target_slug=$TARGET_SLUG" >> $GITHUB_OUTPUT

      - name: Fetch latest data from WordPress
        env:
          WP_PAGE_IDS: ${{ github.event.inputs.wp_post_ids }}
          WP_JWT: ${{ secrets.WP_JWT }}
        run: |
          echo "WordPress„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠..."
          # ÊòéÁ§∫ÁöÑ„Å´WP_URL„ÇíË®≠ÂÆö
          export WP_URL="${{ secrets.WP_URL }}"
          node scripts/fetch-acf.js
          echo "„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü"
          ls -la content*.json
          cat content.json | jq

      - name: Build PDF
        id: build-pdf
        env:
          SLUG: ${{ steps.set-slug.outputs.target_slug }}
        run: |
          node build.js
          
          # ÂÆüÈöõ„Å´ÁîüÊàê„Åï„Çå„ÅüPDF„Éï„Ç°„Ç§„É´„ÇíË¶ã„Å§„Åë„Çã
          echo "„Éì„É´„Éâ„Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„ÅÆPDF„Éï„Ç°„Ç§„É´:"
          find . -type f -name "*.pdf" | sort
          
          # „Çπ„É©„ÉÉ„Ç∞„Éô„Éº„Çπ„ÅÆ„Éï„Ç°„Ç§„É´Âêç„ÇíÂÑ™ÂÖà
          ACTUAL_PDF_FILENAME=$(find . -type f -name "booklet-*.pdf" | head -n 1)
          ACTUAL_PDF_FILENAME=$(basename "$ACTUAL_PDF_FILENAME")
          
          echo "Ê§úÂá∫„Åï„Çå„ÅüPDF„Éï„Ç°„Ç§„É´: $ACTUAL_PDF_FILENAME"
          echo "pdf_file=$ACTUAL_PDF_FILENAME" >> $GITHUB_OUTPUT
          
          # „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíÂèñÂæó„Åó„Å¶‰∫∫Èñì„ÅåË™≠„ÇÅ„ÇãÂΩ¢Âºè„ÅßË°®Á§∫
          FILE_SIZE=$(stat -c%s "$ACTUAL_PDF_FILENAME")
          FILE_SIZE_HUMAN=$(numfmt --to=iec --suffix=B $FILE_SIZE)
          echo "pdf_size=$FILE_SIZE_HUMAN" >> $GITHUB_OUTPUT

      - name: Upload PDF to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: booklet
          path: ${{ steps.build-pdf.outputs.pdf_file }}
          retention-days: 14

      - name: Upload PDF to WordPress Server via FTP
        id: ftp-upload
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /wp-content/uploads/pdf-booklet/
          exclude: |
            **/*
            !${{ steps.build-pdf.outputs.pdf_file }}
          dangerous-clean-slate: false
          
      - name: Display Upload Information
        env:
          PDF_FILENAME: ${{ steps.build-pdf.outputs.pdf_file }}
          PDF_SIZE: ${{ steps.build-pdf.outputs.pdf_size }}
        run: |
          echo "==================================================================="
          echo "üìÑ PDFÊÉÖÂ†±"
          echo "==================================================================="
          echo "üì¶ „Éï„Ç°„Ç§„É´Âêç: $PDF_FILENAME"
          echo "üìä „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫: $PDF_SIZE"
          echo "üåê „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÖàFTP„Éë„Çπ: /wp-content/uploads/pdf-booklet/$PDF_FILENAME"
          
          # WordPress„Çµ„Ç§„Éà‰∏ä„ÅÆURL
          WP_BASE_URL="https://kazumanishiwaki.net/ks"
          UPLOAD_PATH="wp-content/uploads/pdf-booklet"
          echo "üîç WordPress„Ç¢„ÇØ„Çª„ÇπURL: $WP_BASE_URL/$UPLOAD_PATH/$PDF_FILENAME"
          echo "==================================================================="
      
      - name: Notify WordPress with Run ID
        env:
          WEBHOOK: ${{ secrets.WP_WEBHOOK_URL }}
          POST_ID: ${{ steps.set-slug.outputs.target_slug }}
        run: |
          curl -X POST "$WEBHOOK" \
          -H "Content-Type: application/json" \
          -d "{\"run_id\": \"${{ github.run_id }}\", \"post_id\": \"$POST_ID\", \"pdf_uploaded\": true, \"pdf_filename\": \"${{ steps.build-pdf.outputs.pdf_file }}\"}"
