name: Generate PDF

on:
  workflow_dispatch:
    inputs:
      wp_post_ids:
        description: 'WordPressÊäïÁ®øIDÔºàË§áÊï∞„ÅÆÂ†¥Âêà„ÅØ„Ç´„É≥„ÉûÂå∫Âàá„ÇäÔºâ'
        required: true
        default: ''
      target_slug:
        description: '„Éì„É´„ÉâÂØæË±°„ÅÆ„Çπ„É©„ÉÉ„Ç∞ÔºàÊåáÂÆö„Åå„Å™„Åë„Çå„Å∞ÊúÄÂàù„ÅÆID„Çí‰ΩøÁî®Ôºâ'
        required: false
        default: ''
      template_type:
        description: '„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çø„Ç§„ÉóÔºà‰æã: peoplelist, text-photo2Ôºâ„ÄÇÊåáÂÆö„Å™„Åó„ÅÆÂ†¥Âêà„ÅØËá™ÂãïÊ§úÂá∫'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'          

      - name: Install dependencies
        run: npm ci

      - name: Set build slug
        id: set-slug
        run: |
          TARGET_SLUG="${{ github.event.inputs.target_slug }}"
          if [ -z "$TARGET_SLUG" ]; then
            # „Çø„Éº„Ç≤„ÉÉ„Éà„Çπ„É©„ÉÉ„Ç∞„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÊúÄÂàù„ÅÆID„Çí‰ΩøÁî®
            IDS="${{ github.event.inputs.wp_post_ids }}"
            FIRST_ID=$(echo $IDS | cut -d ',' -f1)
            TARGET_SLUG=$FIRST_ID
          fi
          echo "‰ΩøÁî®„Åô„Çã„Çπ„É©„ÉÉ„Ç∞: $TARGET_SLUG"
          echo "target_slug=$TARGET_SLUG" >> $GITHUB_OUTPUT
          
          # „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çø„Ç§„Éó„ÅÆË®≠ÂÆöÔºàÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ôºâ
          TEMPLATE_TYPE="${{ github.event.inputs.template_type }}"
          if [ ! -z "$TEMPLATE_TYPE" ]; then
            echo "„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çø„Ç§„Éó: $TEMPLATE_TYPE"
            echo "template_type=$TEMPLATE_TYPE" >> $GITHUB_OUTPUT
          fi

      - name: Fetch latest data from WordPress
        env:
          WP_PAGE_IDS: ${{ github.event.inputs.wp_post_ids }}
          WP_JWT: ${{ secrets.WP_JWT }}
        run: |
          echo "WordPress„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠..."
          # ÊòéÁ§∫ÁöÑ„Å´WP_URL„ÇíË®≠ÂÆö
          export WP_URL="${{ secrets.WP_URL }}"
          node scripts/fetch-acf.js
          echo "„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü"
          ls -la content*.json
          cat content.json | jq

      - name: List available templates
        run: |
          echo "Âà©Áî®ÂèØËÉΩ„Å™„ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß:"
          ls -la templates/*.ejs
          echo ""

      - name: Build PDF
        id: build-pdf
        env:
          SLUG: ${{ steps.set-slug.outputs.target_slug }}
          TEMPLATE_TYPE: ${{ steps.set-slug.outputs.template_type }}
        run: |
          node build.js
          
          # „Éì„É´„Éâ„Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„ÅÆPDF„Éï„Ç°„Ç§„É´„ÇíË°®Á§∫
          echo "„Éì„É´„Éâ„Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„ÅÆPDF„Éï„Ç°„Ç§„É´:"
          find . -type f -name "*.pdf" | sort
          
          # Êï∞ÂÄ§‰ª•Â§ñ„ÅÆ„Çπ„É©„ÉÉ„Ç∞Âêç„ÇíÊåÅ„Å§PDF„Éï„Ç°„Ç§„É´„ÇíÂÑ™ÂÖàÁöÑ„Å´Ê§úÁ¥¢ÔºàËã±Â≠ó„ÇíÂê´„ÇÄ„Éï„Ç°„Ç§„É´Âêç„ÇíÊ§úÁ¥¢Ôºâ
          SLUG_PDF=$(find . -type f -name "booklet-*.pdf" | grep -v "booklet-[0-9]*.pdf" | head -n 1)
          
          if [ ! -z "$SLUG_PDF" ]; then
            # Ëã±Êï∞Â≠ó„ÅÆ„Çπ„É©„ÉÉ„Ç∞„ÇíÊåÅ„Å§PDF„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Å£„ÅüÂ†¥Âêà
            ACTUAL_PDF_FILENAME=$(basename "$SLUG_PDF")
            echo "„Çπ„É©„ÉÉ„Ç∞„Éô„Éº„Çπ„ÅÆPDF„Éï„Ç°„Ç§„É´„ÇíÊ§úÂá∫: $ACTUAL_PDF_FILENAME"
          else
            # Ëã±Êï∞Â≠ó„ÅÆ„Çπ„É©„ÉÉ„Ç∞„ÇíÊåÅ„Å§PDF„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅ‰ªªÊÑè„ÅÆbooklet-*.pdf„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢
            ACTUAL_PDF_FILENAME=$(find . -type f -name "booklet-*.pdf" | head -n 1)
            ACTUAL_PDF_FILENAME=$(basename "$ACTUAL_PDF_FILENAME")
            echo "Êï∞ÂÄ§ID„Éô„Éº„Çπ„ÅÆPDF„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®: $ACTUAL_PDF_FILENAME"
          fi
          
          echo "Ê§úÂá∫„Åï„Çå„ÅüPDF„Éï„Ç°„Ç§„É´: $ACTUAL_PDF_FILENAME"
          echo "pdf_file=$ACTUAL_PDF_FILENAME" >> $GITHUB_OUTPUT
          
          # booklet-„Å™„Åó„ÅÆÊñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´Âêç„Çí‰ΩúÊàêÔºàÊé•È†≠Ë™û„ÇíÂâäÈô§Ôºâ
          NEW_FILENAME="${ACTUAL_PDF_FILENAME#booklet-}"
          echo "Êñ∞„Åó„ÅÑ„Éï„Ç°„Ç§„É´Âêç: $NEW_FILENAME"
          echo "new_pdf_file=$NEW_FILENAME" >> $GITHUB_OUTPUT
          
          # „Éï„Ç°„Ç§„É´„Çí„Ç≥„Éî„Éº
          cp "$ACTUAL_PDF_FILENAME" "$NEW_FILENAME"
          
          # „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíÂèñÂæó„Åó„Å¶‰∫∫Èñì„ÅåË™≠„ÇÅ„ÇãÂΩ¢Âºè„ÅßË°®Á§∫
          FILE_SIZE=$(stat -c%s "$NEW_FILENAME")
          FILE_SIZE_HUMAN=$(numfmt --to=iec --suffix=B $FILE_SIZE)
          echo "pdf_size=$FILE_SIZE_HUMAN" >> $GITHUB_OUTPUT

      - name: Upload PDF to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: booklet
          path: ${{ steps.build-pdf.outputs.new_pdf_file }}
          retention-days: 14

      - name: Upload PDF to WordPress Server via FTP
        id: ftp-upload
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: cfakyoto.com/public_html/chorakukan/wp-content/uploads/pdf-booklet/
          exclude: |
            **/*
            !${{ steps.build-pdf.outputs.new_pdf_file }}
            !${{ steps.build-pdf.outputs.pdf_file }}
          dangerous-clean-slate: false
          
      - name: Display Upload Information
        env:
          PDF_FILENAME: ${{ steps.build-pdf.outputs.new_pdf_file }}
          PDF_ORIG_FILENAME: ${{ steps.build-pdf.outputs.pdf_file }}
          PDF_SIZE: ${{ steps.build-pdf.outputs.pdf_size }}
        run: |
          echo "==================================================================="
          echo "üìÑ PDFÊÉÖÂ†±"
          echo "==================================================================="
          echo "üì¶ „Çπ„É©„ÉÉ„Ç∞Áâà„Éï„Ç°„Ç§„É´Âêç: $PDF_FILENAME"
          echo "üì¶ IDÁâà„Éï„Ç°„Ç§„É´Âêç: $PDF_ORIG_FILENAME"
          echo "üìä „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫: $PDF_SIZE"
          echo "üåê „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÖàFTP„Éë„Çπ:"
          echo "   - cfakyoto.com/public_html/chorakukan/wp-content/uploads/pdf-booklet/$PDF_FILENAME"
          echo "   - cfakyoto.com/public_html/chorakukan/wp-content/uploads/pdf-booklet/$PDF_ORIG_FILENAME"
          
          # WordPress„Çµ„Ç§„Éà‰∏ä„ÅÆURL
          WP_BASE_URL="http://cfakyoto.com/chorakukan/"
          echo "üîç WordPress„Ç¢„ÇØ„Çª„ÇπURL:"
          echo "   - $WP_BASE_URL/wp-content/uploads/pdf-booklet/$PDF_FILENAME"
          echo "   - $WP_BASE_URL/wp-content/uploads/pdf-booklet/$PDF_ORIG_FILENAME"
          echo "==================================================================="
      
      - name: Notify WordPress with Run ID
        env:
          WEBHOOK: ${{ secrets.WP_WEBHOOK_URL }}
          POST_ID: ${{ steps.set-slug.outputs.target_slug }}
          PDF_FILENAME: ${{ steps.build-pdf.outputs.new_pdf_file }}
          PDF_ORIG_FILENAME: ${{ steps.build-pdf.outputs.pdf_file }}
        run: |
          curl -X POST "$WEBHOOK" \
          -H "Content-Type: application/json" \
          -d "{\"run_id\": \"${{ github.run_id }}\", \"post_id\": \"$POST_ID\", \"pdf_uploaded\": true, \"pdf_filename\": \"$PDF_FILENAME\", \"pdf_orig_filename\": \"$PDF_ORIG_FILENAME\"}"
