name: Generate PDF Booklets

on:
  workflow_dispatch:
    inputs:
      wp_post_ids:
        description: 'WordPress ãƒšãƒ¼ã‚¸/æŠ•ç¨¿IDï¼ˆã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Š: 123,456,789ï¼‰'
        required: true
      target_slug:
        description: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹ãƒšãƒ¼ã‚¸IDã¾ãŸã¯ã‚¹ãƒ©ãƒƒã‚°ï¼ˆä»»æ„ï¼‰'
        required: false
        default: ''
      template_type:
        description: 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆç©ºãªã‚‰è‡ªå‹•åˆ¤å®šï¼‰'
        required: false
        default: ''
      concurrency:
        description: 'PDF åŒæ™‚ç”Ÿæˆæ•°ï¼ˆVivliostyleå®‰å®šã®ãŸã‚ 2ã€œ3 æŽ¨å¥¨ï¼‰'
        required: false
        default: '2'
      skip_schema:
        description: 'ã‚¹ã‚­ãƒ¼ãƒžæ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ1/true ã§ã‚¹ã‚­ãƒƒãƒ—ï¼‰'
        required: false
        default: '0'
      allow_dummy:
        description: 'ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚’è¨±å¯ï¼ˆ1/true ã§è¨±å¯ï¼‰'
        required: false
        default: '0'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      WP_URL: ${{ secrets.WP_URL }}
      WP_USER: ${{ secrets.WP_USER }}
      WP_PASS: ${{ secrets.WP_PASS }}
      WP_JWT: ${{ secrets.WP_JWT }}
      WP_BASIC_USER: ${{ secrets.WP_BASIC_USER }}
      WP_BASIC_PASS: ${{ secrets.WP_BASIC_PASS }}
      ON_ERROR: "continue"
      CONCURRENCY: ${{ github.event.inputs.concurrency }}
      TEMPLATE_TYPE: ${{ github.event.inputs.template_type }}
      SKIP_SCHEMA: ${{ github.event.inputs.skip_schema }}
      TARGET_SLUG: ${{ github.event.inputs.target_slug }}
      WEBHOOK: ${{ secrets.WP_WEBHOOK_URL }}
      ALLOW_DUMMY: ${{ github.event.inputs.allow_dummy }}
      FTP_SERVER: ${{ secrets.FTP_SERVER }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_DESTINATION_PATH: ${{ secrets.FTP_DESTINATION_PATH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Fetch ACF (public first)
        env:
          WP_URL: ${{ env.WP_URL }}
          WP_PAGE_IDS: ${{ github.event.inputs.wp_post_ids }}
        run: |
          set -euo pipefail
          echo "ðŸ”Ž Fetch ACF for: $WP_PAGE_IDS"
          test -f scripts/fetch-acf.js
          node scripts/fetch-acf.js "$WP_PAGE_IDS"
          ls -1 content-*.json id-slug-map.json

      - name: Build PDFs
        run: |
          set -euo pipefail
          if [ -f scripts/build-batch.js ]; then
            node scripts/build-batch.js --pdf --out out
          fi

      - name: List generated PDFs
        run: |
          echo "ðŸ“„ Generated PDFs:"
          ls -lah out/booklet-*.pdf || echo "No PDFs found"

      - name: Normalize filename to page ID (optional)
        if: ${{ env.TARGET_SLUG != '' }}
        run: |
          set -euo pipefail
          ID="${TARGET_SLUG}"
          FIRST=$(ls -1 out/booklet-*.pdf 2>/dev/null | head -n1 || true)
          if [ -n "${FIRST}" ]; then
            cp "${FIRST}" "out/booklet-${ID}.pdf"
            echo "ðŸ“„ Renamed to out/booklet-${ID}.pdf"
          else
            echo "âš ï¸ No PDF found to normalize."
          fi

      - name: Stage PDFs for FTP upload
        run: |
          set -euo pipefail
          mkdir -p deploy
          shopt -s nullglob
          files=(out/booklet-*.pdf)
          if [ ${#files[@]} -gt 0 ]; then
            cp out/booklet-*.pdf deploy/
            echo "UPLOAD_HAS_FILES=1" >> "$GITHUB_ENV"
            echo "ðŸ“¦ Staged ${#files[@]} PDF(s) for upload:"
            ls -lah deploy/
          else
            echo "âš ï¸ No PDFs to stage"
            echo "UPLOAD_HAS_FILES=0" >> "$GITHUB_ENV"
          fi

      - name: Set FTP target directory
        if: ${{ env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' && env.FTP_DESTINATION_PATH != '' }}
        run: |
          set -euo pipefail
          dest="${FTP_DESTINATION_PATH%/}/"
          echo "FTP_TARGET_DIR=$dest" >> "$GITHUB_ENV"
          echo "ðŸŽ¯ FTP target directory: $dest"

      - name: Upload PDFs to WordPress via FTP
        if: ${{ env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' && env.FTP_TARGET_DIR != '' && env.UPLOAD_HAS_FILES == '1' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          protocol: ftp
          local-dir: deploy/
          server-dir: ${{ env.FTP_TARGET_DIR }}
          log-level: verbose

      - name: Verify public URL (optional)
        if: ${{ env.WP_URL != '' && env.TARGET_SLUG != '' }}
        run: |
          set -euo pipefail
          URL="${WP_URL%/}/wp-content/uploads/pdf-booklet/booklet-${TARGET_SLUG}.pdf"
          echo "ðŸ” Checking public URL: $URL"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          echo "ðŸ“¡ HTTP response: $code"
          if [ "$code" = "200" ]; then
            echo "âœ… PDF is publicly accessible"
          else
            echo "âš ï¸ PDF not accessible (HTTP $code)"
          fi

      - name: Upload PDFs (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: pdf-booklets
          path: |
            out/booklet-*.pdf
          if-no-files-found: warn
          retention-days: 7

      - name: Notify WordPress (webhook) - optional
        if: ${{ env.WEBHOOK != '' }}
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          echo "ðŸ“£ Sending webhook notification..."
          # Collect files from out/ but do not fail if none exist
          FILES=$((ls -1 out/booklet-*.pdf 2>/dev/null || true) | jq -R . | jq -s .)
          curl -sS -X POST "$WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"run_id\":\"$RUN_ID\",\"files\":$FILES}"
          echo "âœ… Webhook sent to: $WEBHOOK"