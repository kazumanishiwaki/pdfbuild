name: Generate PDF Booklets

on:
  workflow_dispatch:
    inputs:
      wp_post_ids:
        description: 'WordPress „Éö„Éº„Ç∏/ÊäïÁ®øIDÔºà„Ç´„É≥„ÉûÂå∫Âàá„Çä: 123,456,789Ôºâ'
        required: true
      target_slug:
        description: '„Çø„Éº„Ç≤„ÉÉ„Éà„Å®„Å™„Çã„Éö„Éº„Ç∏ID„Åæ„Åü„ÅØ„Çπ„É©„ÉÉ„Ç∞Ôºà‰ªªÊÑèÔºâ'
        required: false
        default: ''
      template_type:
        description: '„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çø„Ç§„ÉóÔºàÁ©∫„Å™„ÇâËá™ÂãïÂà§ÂÆöÔºâ'
        required: false
        default: ''
      concurrency:
        description: 'PDF ÂêåÊôÇÁîüÊàêÊï∞ÔºàVivliostyleÂÆâÂÆö„ÅÆ„Åü„ÇÅ 2„Äú3 Êé®Â•®Ôºâ'
        required: false
        default: '2'
      skip_schema:
        description: '„Çπ„Ç≠„Éº„ÉûÊ§úË®º„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºà1/true „Åß„Çπ„Ç≠„ÉÉ„ÉóÔºâ'
        required: false
        default: '0'
      allow_dummy:
        description: '„ÉÄ„Éü„Éº„Éá„Éº„ÇøÁîüÊàê„ÇíË®±ÂèØÔºà1/true „ÅßË®±ÂèØÔºâ'
        required: false
        default: '0'

# ‰∏¶Ë°åÂÆüË°åÂà∂Âæ°: Âêå„Åò„Éö„Éº„Ç∏ID„Åß„ÅÆÂêåÊôÇÂÆüË°å„ÇíÈò≤„Åê
concurrency:
  group: pdf-generation-${{ github.event.inputs.wp_post_ids }}
  cancel-in-progress: false

jobs:

  build:
    runs-on: ubuntu-latest
    env:
      WP_URL: ${{ secrets.WP_URL }}
      WP_USER: ${{ secrets.WP_USER }}
      WP_PASS: ${{ secrets.WP_PASS }}
      WP_JWT: ${{ secrets.WP_JWT }}
      WP_BASIC_USER: ${{ secrets.WP_BASIC_USER }}
      WP_BASIC_PASS: ${{ secrets.WP_BASIC_PASS }}
      ON_ERROR: "continue"
      CONCURRENCY: ${{ github.event.inputs.concurrency }}
      TEMPLATE_TYPE: ${{ github.event.inputs.template_type }}
      SKIP_SCHEMA: ${{ github.event.inputs.skip_schema }}
      TARGET_SLUG: ${{ github.event.inputs.target_slug }}
      WEBHOOK: ${{ secrets.WP_WEBHOOK_URL }}
      ALLOW_DUMMY: ${{ github.event.inputs.allow_dummy }}
      FTP_SERVER: ${{ secrets.FTP_SERVER }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_DESTINATION_PATH: ${{ secrets.FTP_DESTINATION_PATH }}
      RUN_ID: ${{ github.run_id }}
      RUN_NUMBER: ${{ github.run_number }}

    steps:
    
    
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Setup isolated workspace
        run: |
          echo "üèóÔ∏è Setting up isolated workspace for run ${{ github.run_id }}"
          
          # ÂÆüË°å„Åî„Å®„Å´Áã¨Á´ã„Åó„Åü„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰ΩúÊàê
          WORK_DIR="work-${{ github.run_id }}"
          mkdir -p "$WORK_DIR"/{out,deploy}
          
          # Áí∞Â¢ÉÂ§âÊï∞„Å®„Åó„Å¶Ë®≠ÂÆö
          echo "WORK_DIR=$WORK_DIR" >> "$GITHUB_ENV"
          echo "OUT_DIR=$WORK_DIR/out" >> "$GITHUB_ENV"
          echo "DEPLOY_DIR=$WORK_DIR/deploy" >> "$GITHUB_ENV"
          
          echo "‚úÖ Workspace created: $WORK_DIR"

      - name: Fetch ACF (public first)
        env:
          WP_URL: ${{ env.WP_URL }}
          WP_PAGE_IDS: ${{ github.event.inputs.wp_post_ids }}
          # Ë™çË®ºÊÉÖÂ†±„ÇíÂøÖË¶Å„Å´Âøú„Åò„Å¶Ê∏°„ÅôÔºàÂÖ¨Èñã„Éö„Éº„Ç∏„Å™„Çâ‰∏çË¶Å„ÄÅÈùûÂÖ¨Èñã„Å™„ÇâÂøÖË¶ÅÔºâ
          WP_JWT: ${{ env.WP_JWT }}
          WP_BASIC_USER: ${{ env.WP_BASIC_USER }}
          WP_BASIC_PASS: ${{ env.WP_BASIC_PASS }}
          # „ÉÄ„Éü„Éº„Éá„Éº„ÇøÁîüÊàê„ÇíÁÑ°ÂäπÂåñÔºàÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø‰ΩøÁî®Ôºâ
          ALLOW_DUMMY: 0
        run: |
          set -euo pipefail
          echo "üîé Fetch ACF for: $WP_PAGE_IDS"
          echo "üåê WordPress URL: $WP_URL"
          echo "üéõÔ∏è ALLOW_DUMMY: ${ALLOW_DUMMY:-0}"
          
          # ÂøÖÈ†à„Éë„É©„É°„Éº„Çø„ÅÆÁ¢∫Ë™ç
          if [ -z "${WP_URL:-}" ]; then
            echo "‚ùå ERROR: WP_URL is not set!"
            exit 1
          fi
          
          if [ -z "${WP_PAGE_IDS:-}" ]; then
            echo "‚ùå ERROR: WP_PAGE_IDS is not set!"
            exit 1
          fi
          
          # Ë™çË®ºÊÉÖÂ†±„ÅÆÁ¢∫Ë™çÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
          if [ -n "${WP_JWT:-}" ]; then
            echo "üîê JWT token available"
          elif [ -n "${WP_BASIC_USER:-}" ] && [ -n "${WP_BASIC_PASS:-}" ]; then
            echo "üîê Basic auth available"
          else
            echo "üîì No auth credentials (public access only)"
          fi
          
          # WordPress URL„ÅÆÊé•Á∂ö„ÉÜ„Çπ„Éà
          echo "üîç Testing WordPress connection..."
          if curl -s -f "$WP_URL" > /dev/null; then
            echo "‚úÖ WordPress site is accessible"
          else
            echo "‚ùå WARNING: WordPress site may not be accessible"
          fi
          
          test -f scripts/fetch-acf.js
          
          # fetch-acf.js„ÅÆÂÆüË°åÔºàË©≥Á¥∞„É≠„Ç∞‰ªò„ÅçÔºâ
          echo "üöÄ Running fetch-acf.js in workspace: $WORK_DIR"
          cd "$WORK_DIR"
          if node ../scripts/fetch-acf.js "$WP_PAGE_IDS"; then
            echo "‚úÖ fetch-acf.js completed successfully"
          else
            echo "‚ùå fetch-acf.js failed with exit code $?"
            echo "üîç This may cause dummy data fallback"
            exit 1
          fi
          
          echo "üìÑ Generated files:"
          ls -1 content-*.json id-slug-map.json

      - name: Verify content files
        run: |
          echo "üìã Content verification in: $WORK_DIR"
          cd "$WORK_DIR"
          ls -la content-*.json id-slug-map.json 2>/dev/null || echo "‚ö†Ô∏è Content files not found"
          
          # „ÉÄ„Éü„Éº„Éá„Éº„Çø„ÉÅ„Çß„ÉÉ„ÇØ
          if grep -q "Demo Booklet\|„ÉÄ„Éü„Éº„ÅÆÊú¨Êñá" content-*.json 2>/dev/null; then
            echo "‚ö†Ô∏è WARNING: Dummy data detected!"
          else
            echo "‚úÖ Real WordPress data confirmed"
          fi

      - name: Build PDFs
        run: |
          echo "üèóÔ∏è Building PDFs in: $WORK_DIR"
          cd "$WORK_DIR"
          node ../scripts/build-batch.js --pdf --out out

      - name: Verify PDFs generated
        run: |
          echo "üìÑ Generated PDFs in: $WORK_DIR"
          cd "$WORK_DIR"
          ls -la out/booklet-*.pdf || echo "‚ùå No PDFs generated"

      - name: Normalize filename to page ID (optional)
        if: ${{ env.TARGET_SLUG != '' }}
        run: |
          set -euo pipefail
          cd "$WORK_DIR"
          ID="${TARGET_SLUG}"
          TARGET_FILE="out/booklet-${ID}.pdf"
          
          # ÁîüÊàê„Åï„Çå„ÅüPDF„Éï„Ç°„Ç§„É´„ÇíÊé¢„Åô
          FIRST=$(ls -1 out/booklet-*.pdf 2>/dev/null | head -n1 || true)
          if [ -n "${FIRST}" ]; then
            # Âêå„Åò„Éï„Ç°„Ç§„É´Âêç„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Ç≥„Éî„ÉºÔºà‰∏äÊõ∏„ÅçÔºâ
            if [ "${FIRST}" != "${TARGET_FILE}" ]; then
              cp "${FIRST}" "${TARGET_FILE}"
              echo "üìÑ Copied ${FIRST} to ${TARGET_FILE}"
            else
              echo "‚úÖ File already has correct name: ${TARGET_FILE}"
            fi
          else
            echo "‚ö†Ô∏è No PDF found to normalize."
          fi

      - name: Stage PDFs for FTP upload
        run: |
          cd "$WORK_DIR"
          mkdir -p deploy
          if ls out/booklet-*.pdf 1> /dev/null 2>&1; then
            cp out/booklet-*.pdf deploy/
            echo "‚úÖ PDFs staged for upload"
          else
            echo "‚ö†Ô∏è No PDFs to upload"
          fi

      - name: Set FTP target directory
        if: ${{ env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' }}
        run: |
          set -euo pipefail
          # FTP_DESTINATION_PATH„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà„Çí‰ΩøÁî®
          if [ -n "${FTP_DESTINATION_PATH:-}" ]; then
            dest="${FTP_DESTINATION_PATH%/}/"
          else
            dest="kazumanishiwaki.net/public_html/ks/wp-content/uploads/pdf-booklet/"
            echo "‚ö†Ô∏è FTP_DESTINATION_PATH not set, using default: $dest"
          fi
          echo "FTP_TARGET_DIR=$dest" >> "$GITHUB_ENV"
          echo "üéØ FTP target directory: $dest"



      - name: Upload PDFs to WordPress via FTP
        id: ftp_upload
        if: ${{ env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          protocol: ftp
          local-dir: ${{ env.WORK_DIR }}/deploy/
          server-dir: ${{ env.FTP_TARGET_DIR }}
          log-level: verbose


      - name: Verify public URL (optional)
        if: ${{ env.WP_URL != '' && env.TARGET_SLUG != '' }}
        run: |
          set -euo pipefail
          URL="${WP_URL%/}/wp-content/uploads/pdf-booklet/booklet-${TARGET_SLUG}.pdf"
          echo "üîç Checking public URL: $URL"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          echo "üì° HTTP response: $code"
          if [ "$code" = "200" ]; then
            echo "‚úÖ PDF is publicly accessible"
          else
            echo "‚ö†Ô∏è PDF not accessible (HTTP $code)"
          fi

      - name: Upload PDFs (artifact)
        if: ${{ hashFiles('work-*/out/booklet-*.pdf') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: pdf-booklets-${{ github.run_id }}
          path: |
            ${{ env.WORK_DIR }}/out/booklet-*.pdf
          if-no-files-found: error
          retention-days: 7

      - name: Report if no PDFs generated
        if: ${{ hashFiles('work-*/out/booklet-*.pdf') == '' }}
        run: echo "‚ö†Ô∏è No PDF files were generated"

      - name: Notify WordPress (webhook) - optional
        if: ${{ env.WEBHOOK != '' }}
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          cd "$WORK_DIR"
          echo "üì£ Sending webhook notification..."
          # Collect files from out/ but do not fail if none exist
          FILES=$((ls -1 out/booklet-*.pdf 2>/dev/null || true) | jq -R . | jq -s .)
          curl -sS -X POST "$WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"run_id\":\"$RUN_ID\",\"files\":$FILES}"
          echo "‚úÖ Webhook sent to: $WEBHOOK"

      - name: Cleanup workspace
        if: always()
        run: |
          echo "üßπ Cleaning up workspace: $WORK_DIR"
          if [ -d "$WORK_DIR" ]; then
            rm -rf "$WORK_DIR"
            echo "‚úÖ Workspace cleaned up"
          else
            echo "‚ÑπÔ∏è No workspace to clean"
          fi