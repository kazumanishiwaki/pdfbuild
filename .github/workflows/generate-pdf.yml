name: Generate PDF Booklets

on:
  workflow_dispatch:
    inputs:
      wp_post_ids:
        description: 'WordPress ãƒšãƒ¼ã‚¸/æŠ•ç¨¿IDï¼ˆã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Š: 123,456,789ï¼‰'
        required: true
      target_slug:
        description: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹ãƒšãƒ¼ã‚¸IDã¾ãŸã¯ã‚¹ãƒ©ãƒƒã‚°ï¼ˆä»»æ„ï¼‰'
        required: false
        default: ''
      template_type:
        description: 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆç©ºãªã‚‰è‡ªå‹•åˆ¤å®šï¼‰'
        required: false
        default: ''
      concurrency:
        description: 'PDF åŒæ™‚ç”Ÿæˆæ•°ï¼ˆVivliostyleå®‰å®šã®ãŸã‚ 2ã€œ3 æŽ¨å¥¨ï¼‰'
        required: false
        default: '2'
      skip_schema:
        description: 'ã‚¹ã‚­ãƒ¼ãƒžæ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ1/true ã§ã‚¹ã‚­ãƒƒãƒ—ï¼‰'
        required: false
        default: '0'
  # ä»»æ„: å®šæœŸå®Ÿè¡Œã—ãŸã„å ´åˆã¯æœ‰åŠ¹åŒ–
  # schedule:
  #   - cron: '0 3 * * *'   # JSTã§æ­£åˆã«ã—ãŸã‘ã‚Œã° '0 3 * * *'ï¼ˆGitHubã¯UTCï¼‰

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # WordPress æŽ¥ç¶šå…ˆï¼ˆSecretsã«ä¿å­˜ï¼‰
      WP_URL: ${{ secrets.WP_URL }}
      # WP_USER / WP_PASS ã¯ã€Œå¿…è¦æ™‚ã®ã¿ã€JWTç™ºè¡Œã«ä½¿ã†ï¼ˆå…¬é–‹ãƒšãƒ¼ã‚¸ã ã‘ãªã‚‰ä¸è¦ï¼‰
      WP_USER: ${{ secrets.WP_USER }}
      WP_PASS: ${{ secrets.WP_PASS }}

      # ãƒ“ãƒ«ãƒ‰è¨­å®š
      ON_ERROR: "continue"                         # å¤±æ•—ãƒšãƒ¼ã‚¸ãŒã‚ã£ã¦ã‚‚ç¶šè¡Œï¼ˆfetch-acf.jså¯¾å¿œï¼‰
      CONCURRENCY: ${{ github.event.inputs.concurrency }}
      TEMPLATE_TYPE: ${{ github.event.inputs.template_type }}
      SKIP_SCHEMA: ${{ github.event.inputs.skip_schema }}
      TARGET_SLUG: ${{ github.event.inputs.target_slug }}
      WEBHOOK: ${{ secrets.WP_WEBHOOK_URL }}
      # FTPï¼ˆä»»æ„: WordPress ã¸ã®é…å¸ƒç”¨ãƒ»æ—¢å­˜Secretsã‚’æµç”¨ï¼‰
      FTP_SERVER: ${{ secrets.FTP_SERVER }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_DESTINATION_PATH: ${{ secrets.FTP_DESTINATION_PATH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # cache ã¯ lockfile ãŒãªã„ã¨å¤±æ•—ã™ã‚‹ãŸã‚ä¸€æ—¦ç„¡åŠ¹åŒ–
          # cache: 'npm'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Issue JWT if needed
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${WP_USER:-}" && -n "${WP_PASS:-}" ]]; then
            echo "ðŸ” Try issuing JWT..."
            RESP=$(curl -sS -X POST "$WP_URL/wp-json/jwt-auth/v1/token" \
              -H "Content-Type: application/json" \
              -d "{\"username\":\"$WP_USER\",\"password\":\"$WP_PASS\"}") || true
            TOKEN=$(echo "$RESP" | jq -r '.token // empty')
            if [[ -n "$TOKEN" ]]; then
              echo "WP_JWT=$TOKEN" >> "$GITHUB_ENV"
              echo "âœ… JWT issued"
            else
              echo "âš ï¸ JWT not issued (will try without Authorization if possible)"
            fi
          else
            echo "â„¹ï¸ No WP_USER/WP_PASS provided. Will call API without JWT."
          fi

      - name: Fetch ACF JSONs
        env:
          WP_PAGE_IDS: ${{ github.event.inputs.wp_post_ids }}
        run: |
          set -euo pipefail
          echo "ðŸ”Ž Fetch ACF for: $WP_PAGE_IDS"
          # scripts/fetch-acf.jsï¼ˆåˆ†å‰²ç‰ˆï¼‰ or ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã® fetch-acf.jsï¼ˆå˜ä½“ç‰ˆï¼‰ã®ã©ã¡ã‚‰ã«ã‚‚å¯¾å¿œ
          if [ -f scripts/fetch-acf.js ]; then
            node scripts/fetch-acf.js "$WP_PAGE_IDS"
          elif [ -f fetch-acf.js ]; then
            node fetch-acf.js "$WP_PAGE_IDS"
          else
            echo "âš ï¸ fetch-acf.js ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™"
            node -e '
              const fs = require("fs");
              const ids = (process.env.WP_PAGE_IDS||"").split(",").map(s=>s.trim()).filter(Boolean);
              const id = Number(ids[0]||123);
              const slug = "demo";
              fs.writeFileSync("id-slug-map.json", JSON.stringify({[String(id)]: slug, [slug]: id}, null, 2));
              fs.writeFileSync(`content-${slug}.json`, JSON.stringify({ id, slug, template: "text-photo2", title: "Demo from CI", content: "ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆCIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ã€‚", caption1: "", caption2: "" }, null, 2));
              console.log("wrote id-slug-map.json and content-"+slug+".json");
            '
          fi
          ls -1 content-*.json id-slug-map.json

      - name: Build PDFs (batch)
        run: |
          set -euo pipefail
          # ã¾ãš Tailwind ã‚’ä¸€åº¦ã ã‘ãƒ“ãƒ«ãƒ‰ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          if [ -f ./node_modules/.bin/tailwindcss ] && [ -f ./src/input.css ]; then
            ./node_modules/.bin/tailwindcss -i ./src/input.css -o ./dist/output.css
          fi

          if [ -f scripts/build-batch.js ]; then
            # åˆ†å‰²ç‰ˆï¼ˆæŽ¨å¥¨æ§‹æˆï¼‰
            node scripts/build-batch.js --pdf --out out
          else
            # æ—¢å­˜å˜ä½“ build.js ã‚’ä¸¦åˆ—åˆ¶å¾¡ã§å›žã™ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            test -f id-slug-map.json
            SLUGS=$(jq -r 'to_entries[] | select(.key|test("^[0-9]+$")|not) | .key' id-slug-map.json)
            echo "ðŸ§¾ Slugs: $SLUGS"
            i=0; max="${CONCURRENCY:-2}"; pids=()
            for slug in $SLUGS; do
              (
                export TEMPLATE_TYPE
                export SLUG="$slug"   # build.js ãŒ SLUG or PAGE_ID ã‚’èª­ã‚€æƒ³å®š
                node build.js
              ) &
              pids+=($!)
              i=$((i+1))
              if [ "$i" -ge "$max" ]; then
                wait -n || true
                i=$((i-1))
              fi
            done
            for pid in "${pids[@]}"; do wait "$pid" || true; done
          fi

      - name: Normalize filename to page ID (optional)
        if: ${{ env.TARGET_SLUG != '' }}
        run: |
          set -euo pipefail
          ID="${TARGET_SLUG}"
          FIRST=$(ls -1 out/booklet-*.pdf 2>/dev/null | head -n1 || true)
          if [ -n "${FIRST}" ]; then
            cp "${FIRST}" "out/booklet-${ID}.pdf"
            echo "Renamed to out/booklet-${ID}.pdf"
          else
            echo "No PDF found to normalize."
          fi

      - name: List PDFs
        run: ls -lah out/booklet-*.pdf || echo "no PDFs?"

      - name: Stage PDFs for FTP upload (optional)
        run: |
          set -euo pipefail
          mkdir -p deploy
          cp out/booklet-*.pdf deploy/ 2>/dev/null || echo "No PDFs to stage"

      - name: Upload PDFs to WordPress via FTP (optional)
        if: ${{ env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' && env.FTP_DESTINATION_PATH != '' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          protocol: ftp
          local-dir: deploy/
          server-dir: ${{ env.FTP_DESTINATION_PATH }}

      - name: Upload PDFs (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: pdf-booklets
          path: |
            out/booklet-*.pdf
          if-no-files-found: warn
          retention-days: 7

      # ä»»æ„: S3/R2/SFTP ãªã©ã®é…å¸ƒå…ˆã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ãªã‚‰ã€ã“ã“ã«è¿½åŠ 

      - name: Notify WordPress (webhook) - optional
        if: ${{ env.WEBHOOK != '' }}
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          # Collect files from out/ but do not fail if none exist
          FILES=$((ls -1 out/booklet-*.pdf 2>/dev/null || true) | jq -R . | jq -s .)
          curl -sS -X POST "$WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"run_id\":\"$RUN_ID\",\"files\":$FILES}"
          echo "ðŸ“£ Notified: $WEBHOOK"
