name: Generate PDF Booklets

on:
  workflow_dispatch:
    inputs:
      wp_post_ids:
        description: 'WordPress ãƒšãƒ¼ã‚¸/æŠ•ç¨¿IDï¼ˆã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Š: 123,456,789ï¼‰'
        required: true
      target_slug:
        description: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹ãƒšãƒ¼ã‚¸IDã¾ãŸã¯ã‚¹ãƒ©ãƒƒã‚°ï¼ˆä»»æ„ï¼‰'
        required: false
        default: ''
      template_type:
        description: 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆç©ºãªã‚‰è‡ªå‹•åˆ¤å®šï¼‰'
        required: false
        default: ''
      concurrency:
        description: 'PDF åŒæ™‚ç”Ÿæˆæ•°ï¼ˆVivliostyleå®‰å®šã®ãŸã‚ 2ã€œ3 æŽ¨å¥¨ï¼‰'
        required: false
        default: '2'
      skip_schema:
        description: 'ã‚¹ã‚­ãƒ¼ãƒžæ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ1/true ã§ã‚¹ã‚­ãƒƒãƒ—ï¼‰'
        required: false
        default: '0'
      allow_dummy:
        description: 'ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚’è¨±å¯ï¼ˆ1/true ã§è¨±å¯ï¼‰'
        required: false
        default: '0'

jobs:

  build:
    runs-on: ubuntu-latest
    env:
      WP_URL: ${{ secrets.WP_URL }}
      WP_USER: ${{ secrets.WP_USER }}
      WP_PASS: ${{ secrets.WP_PASS }}
      WP_JWT: ${{ secrets.WP_JWT }}
      WP_BASIC_USER: ${{ secrets.WP_BASIC_USER }}
      WP_BASIC_PASS: ${{ secrets.WP_BASIC_PASS }}
      ON_ERROR: "continue"
      CONCURRENCY: ${{ github.event.inputs.concurrency }}
      TEMPLATE_TYPE: ${{ github.event.inputs.template_type }}
      SKIP_SCHEMA: ${{ github.event.inputs.skip_schema }}
      TARGET_SLUG: ${{ github.event.inputs.target_slug }}
      WEBHOOK: ${{ secrets.WP_WEBHOOK_URL }}
      ALLOW_DUMMY: ${{ github.event.inputs.allow_dummy }}
      FTP_SERVER: ${{ secrets.FTP_SERVER }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_DESTINATION_PATH: ${{ secrets.FTP_DESTINATION_PATH }}

    steps:
    
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Clean previous files
        run: |
          echo "ðŸ§¹ Cleaning previous generated files..."
          rm -f content-*.json id-slug-map.json out/booklet-*.html out/booklet-*.pdf
          echo "âœ… Cleanup completed"

      - name: Fetch ACF (public first)
        env:
          WP_URL: ${{ env.WP_URL }}
          WP_PAGE_IDS: ${{ github.event.inputs.wp_post_ids }}
          # èªè¨¼æƒ…å ±ã‚’å¿…è¦ã«å¿œã˜ã¦æ¸¡ã™ï¼ˆå…¬é–‹ãƒšãƒ¼ã‚¸ãªã‚‰ä¸è¦ã€éžå…¬é–‹ãªã‚‰å¿…è¦ï¼‰
          WP_JWT: ${{ env.WP_JWT }}
          WP_BASIC_USER: ${{ env.WP_BASIC_USER }}
          WP_BASIC_PASS: ${{ env.WP_BASIC_PASS }}
          # ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚’ç„¡åŠ¹åŒ–ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨ï¼‰
          ALLOW_DUMMY: 0
        run: |
          set -euo pipefail
          echo "ðŸ”Ž Fetch ACF for: $WP_PAGE_IDS"
          echo "ðŸŒ WordPress URL: $WP_URL"
          echo "ðŸŽ›ï¸ ALLOW_DUMMY: ${ALLOW_DUMMY:-0}"
          
          # å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç¢ºèª
          if [ -z "${WP_URL:-}" ]; then
            echo "âŒ ERROR: WP_URL is not set!"
            exit 1
          fi
          
          if [ -z "${WP_PAGE_IDS:-}" ]; then
            echo "âŒ ERROR: WP_PAGE_IDS is not set!"
            exit 1
          fi
          
          # èªè¨¼æƒ…å ±ã®ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          if [ -n "${WP_JWT:-}" ]; then
            echo "ðŸ” JWT token available"
          elif [ -n "${WP_BASIC_USER:-}" ] && [ -n "${WP_BASIC_PASS:-}" ]; then
            echo "ðŸ” Basic auth available"
          else
            echo "ðŸ”“ No auth credentials (public access only)"
          fi
          
          # WordPress URLã®æŽ¥ç¶šãƒ†ã‚¹ãƒˆ
          echo "ðŸ” Testing WordPress connection..."
          if curl -s -f "$WP_URL" > /dev/null; then
            echo "âœ… WordPress site is accessible"
          else
            echo "âŒ WARNING: WordPress site may not be accessible"
          fi
          
          test -f scripts/fetch-acf.js
          
          # fetch-acf.jsã®å®Ÿè¡Œï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
          echo "ðŸš€ Running fetch-acf.js..."
          if node scripts/fetch-acf.js "$WP_PAGE_IDS"; then
            echo "âœ… fetch-acf.js completed successfully"
          else
            echo "âŒ fetch-acf.js failed with exit code $?"
            echo "ðŸ” This may cause dummy data fallback"
            exit 1
          fi
          
          echo "ðŸ“„ Generated files:"
          ls -1 content-*.json id-slug-map.json

      - name: Debug fetched content
        run: |
          echo "ðŸ” Checking fetched content for dummy data..."
          
          # id-slug-map.jsonã®å†…å®¹ç¢ºèª
          if [ -f id-slug-map.json ]; then
            echo "ðŸ“‹ ID-Slug mapping:"
            cat id-slug-map.json | jq .
          else
            echo "âŒ id-slug-map.json not found!"
          fi
          
          # content-*.jsonãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          for file in content-*.json; do
            if [ -f "$file" ]; then
              echo ""
              echo "ðŸ“„ ===== Content file: $file ====="
              
              # ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã®å†…å®¹ã‚’è¡¨ç¤º
              echo "ðŸ“ Complete file contents:"
              cat "$file" | jq . || cat "$file"
              
              echo ""
              echo "ðŸ” Data analysis:"
              
              # å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è©³ç´°ç¢ºèª
              echo "   ID: $(cat "$file" | jq -r '.id // "N/A"')"
              echo "   Slug: $(cat "$file" | jq -r '.slug // "N/A"')"
              echo "   Title: $(cat "$file" | jq -r '.title // "N/A"')"
              echo "   Template: $(cat "$file" | jq -r '.template // "N/A"')"
              
              # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç¢ºèª
              CONTENT=$(cat "$file" | jq -r '.content // "N/A"')
              echo "   Content length: ${#CONTENT} characters"
              echo "   Content preview: ${CONTENT:0:200}..."
              
              # ç”»åƒã®ç¢ºèª
              PHOTO1=$(cat "$file" | jq -r '.photo1.url // .photo1 // "N/A"')
              PHOTO2=$(cat "$file" | jq -r '.photo2.url // .photo2 // "N/A"')
              echo "   Photo1 URL: $PHOTO1"
              echo "   Photo2 URL: $PHOTO2"
              
              # ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®ç¢ºèª
              echo "   Caption1: $(cat "$file" | jq -r '.caption1 // "N/A"')"
              echo "   Caption2: $(cat "$file" | jq -r '.caption2 // "N/A"')"
              
              # ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
              if grep -q "Demo Booklet\|ãƒ€ãƒŸãƒ¼ã®æœ¬æ–‡" "$file"; then
                echo "âš ï¸ WARNING: $file contains DUMMY data!"
              else
                echo "âœ… $file appears to contain real WordPress data"
              fi
              
              echo "ðŸ“„ ===== End of $file ====="
            else
              echo "âŒ No content-*.json files found!"
            fi
          done

      - name: Build PDFs
        run: |
          set -euo pipefail
          echo "ðŸ—ï¸ Starting PDF build process..."
          
          # ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å­˜åœ¨ç¢ºèª
          if [ -f scripts/build-batch.js ]; then
            echo "âœ… Found build-batch.js"
          else
            echo "âŒ build-batch.js not found, checking alternatives..."
            ls -la scripts/
          fi
          
          # å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ðŸ“„ Input files check:"
          if [ -f id-slug-map.json ]; then
            echo "âœ… id-slug-map.json exists"
            echo "   Content: $(cat id-slug-map.json)"
          else
            echo "âŒ id-slug-map.json missing"
          fi
          
          echo "ðŸ“„ Content files:"
          ls -la content-*.json || echo "âŒ No content-*.json files found"
          
          # Tailwindã®ç¢ºèª
          if [ -f ./node_modules/.bin/tailwindcss ] && [ -f ./src/input.css ]; then
            echo "ðŸŽ¨ Building Tailwind CSS..."
            ./node_modules/.bin/tailwindcss -i ./src/input.css -o ./dist/output.css
            echo "âœ… Tailwind CSS built"
          else
            echo "â„¹ï¸ Tailwind CSS not available (optional)"
          fi
          
          # PDFç”Ÿæˆå®Ÿè¡Œ
          if [ -f scripts/build-batch.js ]; then
            echo "ðŸš€ Running PDF generation..."
            echo "   Command: node scripts/build-batch.js --pdf --out out"
            
            # Node.jsã¨npmã®ç¢ºèª
            echo "ðŸ”§ Environment check:"
            echo "   Node version: $(node --version)"
            echo "   NPM version: $(npm --version)"
            
            # ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
            echo "ðŸ“¦ Dependencies check:"
            if [ -f package.json ]; then
              echo "   package.json exists"
              echo "   Dependencies:"
              cat package.json | jq '.dependencies // {}' 2>/dev/null || echo "   Could not parse dependencies"
            fi
            
            # build-one.jsã®ç¢ºèª
            if [ -f scripts/build-one.js ]; then
              echo "âœ… scripts/build-one.js exists"
            else
              echo "âŒ scripts/build-one.js missing - this is required by build-batch.js"
            fi
            
            # å®Ÿè¡Œ
            if node scripts/build-batch.js --pdf --out out; then
              echo "âœ… PDF generation command completed successfully"
            else
              echo "âŒ PDF generation failed with exit code $?"
              echo "ðŸ” Debugging info:"
              echo "   Current directory: $(pwd)"
              echo "   Available files:"
              ls -la
              echo "   Scripts directory:"
              ls -la scripts/
              exit 1
            fi
          else
            echo "âŒ Cannot run PDF generation - build-batch.js missing"
            exit 1
          fi

      - name: List generated PDFs
        run: |
          echo "ðŸ“„ Checking PDF generation results..."
          
          # outãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
          if [ -d out ]; then
            echo "âœ… out/ directory exists"
            echo "ðŸ“ Contents of out/ directory:"
            ls -lah out/ || echo "out/ directory is empty"
          else
            echo "âŒ out/ directory does not exist"
          fi
          
          # PDF ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ðŸ” Looking for PDF files..."
          if ls out/booklet-*.pdf 1> /dev/null 2>&1; then
            echo "âœ… PDF files found:"
            for pdf in out/booklet-*.pdf; do
              if [ -f "$pdf" ]; then
                size=$(stat -f%z "$pdf" 2>/dev/null || stat -c%s "$pdf" 2>/dev/null || echo "unknown")
                echo "   ðŸ“„ $pdf (${size} bytes)"
                
                # PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                if [ "$size" -gt 1000 ]; then
                  echo "      âœ… File size looks reasonable"
                else
                  echo "      âš ï¸ File size seems too small"
                  echo "      Content preview:"
                  head -c 200 "$pdf" | hexdump -C
                fi
              fi
            done
          else
            echo "âŒ No PDF files found"
            echo "ðŸ” Checking for any files in out/:"
            find out -type f -name "*" 2>/dev/null || echo "No files found in out/"
            
            echo "ðŸ” Checking for HTML files (intermediate):"
            find . -name "*.html" -newer id-slug-map.json 2>/dev/null || echo "No recent HTML files found"
          fi

      - name: Normalize filename to page ID (optional)
        if: ${{ env.TARGET_SLUG != '' }}
        run: |
          set -euo pipefail
          ID="${TARGET_SLUG}"
          TARGET_FILE="out/booklet-${ID}.pdf"
          
          # ç”Ÿæˆã•ã‚ŒãŸPDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŽ¢ã™
          FIRST=$(ls -1 out/booklet-*.pdf 2>/dev/null | head -n1 || true)
          if [ -n "${FIRST}" ]; then
            # åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«åã§ãªã„å ´åˆã®ã¿ã‚³ãƒ”ãƒ¼ï¼ˆä¸Šæ›¸ãï¼‰
            if [ "${FIRST}" != "${TARGET_FILE}" ]; then
              cp "${FIRST}" "${TARGET_FILE}"
              echo "ðŸ“„ Copied ${FIRST} to ${TARGET_FILE}"
            else
              echo "âœ… File already has correct name: ${TARGET_FILE}"
            fi
          else
            echo "âš ï¸ No PDF found to normalize."
          fi

      - name: Stage PDFs for FTP upload
        run: |
          set -euo pipefail
          mkdir -p deploy
          shopt -s nullglob
          files=(out/booklet-*.pdf)
          if [ ${#files[@]} -gt 0 ]; then
            cp out/booklet-*.pdf deploy/
            echo "UPLOAD_HAS_FILES=1" >> "$GITHUB_ENV"
            echo "ðŸ“¦ Staged ${#files[@]} PDF(s) for upload:"
            ls -lah deploy/
          else
            echo "âš ï¸ No PDFs to stage"
            echo "UPLOAD_HAS_FILES=0" >> "$GITHUB_ENV"
          fi

      - name: Set FTP target directory
        if: ${{ env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' && env.FTP_DESTINATION_PATH != '' }}
        run: |
          set -euo pipefail
          dest="${FTP_DESTINATION_PATH%/}/"
          echo "FTP_TARGET_DIR=$dest" >> "$GITHUB_ENV"
          echo "ðŸŽ¯ FTP target directory: $dest"

      - name: Upload PDFs to WordPress via FTP
        if: ${{ env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' && env.FTP_TARGET_DIR != '' && env.UPLOAD_HAS_FILES == '1' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          protocol: ftp
          local-dir: deploy/
          server-dir: ${{ env.FTP_TARGET_DIR }}
          log-level: verbose

      - name: Verify public URL (optional)
        if: ${{ env.WP_URL != '' && env.TARGET_SLUG != '' }}
        run: |
          set -euo pipefail
          URL="${WP_URL%/}/wp-content/uploads/pdf-booklet/booklet-${TARGET_SLUG}.pdf"
          echo "ðŸ” Checking public URL: $URL"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          echo "ðŸ“¡ HTTP response: $code"
          if [ "$code" = "200" ]; then
            echo "âœ… PDF is publicly accessible"
          else
            echo "âš ï¸ PDF not accessible (HTTP $code)"
          fi

      - name: Upload PDFs (artifact)
        if: ${{ hashFiles('out/booklet-*.pdf') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: pdf-booklets
          path: |
            out/booklet-*.pdf
          if-no-files-found: error
          retention-days: 7

      - name: Report if no PDFs generated
        if: ${{ hashFiles('out/booklet-*.pdf') == '' }}
        run: |
          echo "âš ï¸ No PDF files were generated"
          echo "ðŸ” This indicates a problem in the PDF generation process"
          echo "ðŸ“ Current out/ directory contents:"
          ls -la out/ || echo "out/ directory does not exist"
          echo "ðŸ“„ Available files in workspace:"
          find . -name "*.json" -o -name "*.html" -o -name "*.pdf" | head -20

      - name: Notify WordPress (webhook) - optional
        if: ${{ env.WEBHOOK != '' }}
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          echo "ðŸ“£ Sending webhook notification..."
          # Collect files from out/ but do not fail if none exist
          FILES=$((ls -1 out/booklet-*.pdf 2>/dev/null || true) | jq -R . | jq -s .)
          curl -sS -X POST "$WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"run_id\":\"$RUN_ID\",\"files\":$FILES}"
          echo "âœ… Webhook sent to: $WEBHOOK"