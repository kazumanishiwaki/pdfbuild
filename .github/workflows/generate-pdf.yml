name: Generate PDF

on:
  workflow_dispatch:
    inputs:
      wp_post_ids:
        description: 'WordPressæŠ•ç¨¿IDï¼ˆè¤‡æ•°ã®å ´åˆã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰'
        required: true
        default: ''
      target_slug:
        description: 'ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã®ã‚¹ãƒ©ãƒƒã‚°ï¼ˆæŒ‡å®šãŒãªã‘ã‚Œã°æœ€åˆã®IDã‚’ä½¿ç”¨ï¼‰'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'          

      - name: Install dependencies
        run: npm ci

      - name: Set build slug
        id: set-slug
        run: |
          TARGET_SLUG="${{ github.event.inputs.target_slug }}"
          if [ -z "$TARGET_SLUG" ]; then
            # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ãƒ©ãƒƒã‚°ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€æœ€åˆã®IDã‚’ä½¿ç”¨
            IDS="${{ github.event.inputs.wp_post_ids }}"
            FIRST_ID=$(echo $IDS | cut -d ',' -f1)
            TARGET_SLUG=$FIRST_ID
          fi
          echo "ä½¿ç”¨ã™ã‚‹ã‚¹ãƒ©ãƒƒã‚°: $TARGET_SLUG"
          echo "target_slug=$TARGET_SLUG" >> $GITHUB_OUTPUT

      - name: Fetch latest data from WordPress
        env:
          WP_PAGE_IDS: ${{ github.event.inputs.wp_post_ids }}
          WP_JWT: ${{ secrets.WP_JWT }}
        run: |
          echo "WordPressã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­..."
          # æ˜ç¤ºçš„ã«WP_URLã‚’è¨­å®š
          export WP_URL="${{ secrets.WP_URL }}"
          node scripts/fetch-acf.js
          echo "ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†"
          ls -la content*.json
          cat content.json | jq

      - name: Build PDF
        id: build-pdf
        env:
          SLUG: ${{ steps.set-slug.outputs.target_slug }}
        run: |
          node build.js
          # ç”Ÿæˆã•ã‚ŒãŸPDFã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å‡ºåŠ›
          PDF_FILENAME="booklet-${{ steps.set-slug.outputs.target_slug }}.pdf"
          echo "pdf_file=$PDF_FILENAME" >> $GITHUB_OUTPUT
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å–å¾—ã—ã¦äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã§è¡¨ç¤º
          FILE_SIZE=$(stat -c%s "$PDF_FILENAME")
          FILE_SIZE_HUMAN=$(numfmt --to=iec --suffix=B $FILE_SIZE)
          echo "pdf_size=$FILE_SIZE_HUMAN" >> $GITHUB_OUTPUT

      - name: Upload PDF to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: booklet
          path: booklet-${{ steps.set-slug.outputs.target_slug }}.pdf
          retention-days: 14

      - name: Upload PDF to WordPress Server via FTP
        id: ftp-upload
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: ${{ secrets.FTP_DESTINATION_PATH }}/
          exclude: |
            **/*
            !booklet-${{ steps.set-slug.outputs.target_slug }}.pdf
          dangerous-clean-slate: false
          
      - name: Display Upload Information
        env:
          PDF_FILENAME: ${{ steps.build-pdf.outputs.pdf_file }}
          PDF_SIZE: ${{ steps.build-pdf.outputs.pdf_size }}
          WP_URL: ${{ secrets.WP_URL }}
          FTP_PATH: ${{ secrets.FTP_DESTINATION_PATH }}
        run: |
          echo "==================================================================="
          echo "ğŸ“„ PDFæƒ…å ±"
          echo "==================================================================="
          echo "ğŸ“¦ ãƒ•ã‚¡ã‚¤ãƒ«å: $PDF_FILENAME"
          echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $PDF_SIZE"
          echo "ğŸŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆFTPãƒ‘ã‚¹: $FTP_PATH/$PDF_FILENAME"
          
          # WordPressã‚µã‚¤ãƒˆä¸Šã®URLã‚’æ¨æ¸¬
          # FTPãƒ‘ã‚¹ãŒã€Œ/wp-content/uploads/pdf-booklet/ã€ã®ã‚ˆã†ãªå½¢å¼ã‚’æƒ³å®š
          UPLOAD_DIR_PATH=$(echo "$FTP_PATH" | sed -e 's/^\/*//' -e 's/\/*$//')
          echo "ğŸ” æ¨å®šWordPressã‚¢ã‚¯ã‚»ã‚¹URL: $WP_URL/$UPLOAD_DIR_PATH/$PDF_FILENAME"
          echo "==================================================================="
      
      - name: Notify WordPress with Run ID
        env:
          WEBHOOK: ${{ secrets.WP_WEBHOOK_URL }}
          POST_ID: ${{ steps.set-slug.outputs.target_slug }}
        run: |
          curl -X POST "$WEBHOOK" \
          -H "Content-Type: application/json" \
          -d "{\"run_id\": \"${{ github.run_id }}\", \"post_id\": \"$POST_ID\", \"pdf_uploaded\": true, \"pdf_filename\": \"${{ steps.build-pdf.outputs.pdf_file }}\"}"
