name: Generate PDF Booklets

on:
  workflow_dispatch:
    inputs:
      wp_post_ids:
        description: 'WordPress ページ/投稿ID（カンマ区切り: 123,456,789）'
        required: true
      target_slug:
        description: 'ターゲットとなるページIDまたはスラッグ（任意）'
        required: false
        default: ''
      template_type:
        description: 'テンプレートタイプ（空なら自動判定）'
        required: false
        default: ''
      concurrency:
        description: 'PDF 同時生成数（Vivliostyle安定のため 2〜3 推奨）'
        required: false
        default: '2'
      skip_schema:
        description: 'スキーマ検証をスキップ（1/true でスキップ）'
        required: false
        default: '0'
      allow_dummy:
        description: 'ダミーデータ生成を許可（1/true で許可）'
        required: false
        default: '0'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      WP_URL: ${{ secrets.WP_URL }}
      WP_USER: ${{ secrets.WP_USER }}
      WP_PASS: ${{ secrets.WP_PASS }}
      WP_JWT: ${{ secrets.WP_JWT }}
      WP_BASIC_USER: ${{ secrets.WP_BASIC_USER }}
      WP_BASIC_PASS: ${{ secrets.WP_BASIC_PASS }}
      ON_ERROR: "continue"
      CONCURRENCY: ${{ github.event.inputs.concurrency }}
      TEMPLATE_TYPE: ${{ github.event.inputs.template_type }}
      SKIP_SCHEMA: ${{ github.event.inputs.skip_schema }}
      TARGET_SLUG: ${{ github.event.inputs.target_slug }}
      WEBHOOK: ${{ secrets.WP_WEBHOOK_URL }}
      ALLOW_DUMMY: ${{ github.event.inputs.allow_dummy }}
      FTP_SERVER: ${{ secrets.FTP_SERVER }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_DESTINATION_PATH: ${{ secrets.FTP_DESTINATION_PATH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Fetch ACF JSONs
        env:
          WP_PAGE_IDS: ${{ github.event.inputs.wp_post_ids }}
        run: |
          set -euo pipefail
          echo "🔎 Fetch ACF for: $WP_PAGE_IDS"
          test -f scripts/fetch-acf.js
          node scripts/fetch-acf.js "$WP_PAGE_IDS"

      - name: Build PDFs
        run: |
          set -euo pipefail
          if [ -f scripts/build-batch.js ]; then
            node scripts/build-batch.js --pdf --out out
          fi

      - name: Upload PDFs
        uses: actions/upload-artifact@v4
        with:
          name: pdf-booklets
          path: out/booklet-*.pdf
          if-no-files-found: warn
          retention-days: 7
